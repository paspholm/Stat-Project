---
output:
  pdf_document: default
  html_document: default
---
# Checkpoint 2 {-}

**You can download a template RMarkdown file to start from [here](template_rmds/checkpoint-2.Rmd).**

This work should be done individually meaning that each person should have their own keyword and data set. You should support each other in your work but make sure that what you type in this document reflects your words and ideas. 

## Google Trends {-}

Go to https://trends.google.com/trends/?geo=US and try out a variety of keywords. Make sure to change the plot to 2004-present. The time series you see is the search interest relative to the highest point on the chart for the given region and time. A value of 100 is the peak popularity for the term. A value of 50 means that the term is half as popular. A score of 0 means there was not enough data to estimate the search interest for this term. 

1. Choose a keyword associated with a search that has a series with a non-constant trend and some seasonality. Tell me what that keyword is. 

ANSWER: MLB





2. Download the Google trend data (look for the down arrow). Put the file in a known location on your computer. Look at the csv file and then read in the data into R.


```{r}
library(dplyr)
library(ggplot2)
library(readr)
library(lubridate)

mlb = read.csv("multiTimeline.csv")
colnames(mlb) = c("popularity")
mlb = mlb[-1,, drop = FALSE]
mlb = mlb %>%
  mutate(popularity = as.numeric(popularity))
```



3. Come up with at least two estimates of the trend. Plot both of those estimates as a function of time. Justify which estimate you prefer.

ANSWER: I estimated the trend of the data using a 12 Month moving average filter and a simple linear regression model. I prefer the moving average estimation because it captures the trend of the data better. The linear regression assumes a linear relationship, which is not the case and therefore does not do a very good job of capturing the trend.

```{r}
mlb_data = ts(mlb, start = 2004, frequency = 12)

#Model 1 is a 12 Month moving average
fltr <- c(.5 / 12, rep(1/12, 11), .5/12) #filter
mlb <- mlb %>%
  mutate(mlbTrend1 = as.numeric(stats::filter(mlb_data, filter = fltr, method = 'convo', sides = 2)))

#Model 2 is linear regression
mlb <- mlb %>%
  mutate(Month = (1:nrow(mlb) - 1) %% 12 + 1,
         Year = rep((1:nrow(mlb) - 1) %/% 12 + 2004),
         Date = paste(Year, Month, 1 , sep = '-'),
         Date = ymd(Date), 
         mlbTrend2 = predict(lm(popularity ~ Date, data = mlb)))
         

mlb  %>% 
  ggplot(aes(x = Date, y = popularity)) +
  geom_line() + 
  geom_point() +
  geom_line(aes(y = mlbTrend1), color = "red") +
  geom_line(aes(y = mlbTrend2), color = "green") +
  theme_minimal()
```

4. Plot the de-trended series (residuals = original outcome data - estimated trend). Comment on the de-trended series.

ANSWER: The residual plot shows that the moving average filter does a very good job of removing the trend, but there appears to be heteroscedasticity in the data.

```{r}

mlb = mlb %>%
  mutate(Detrend = popularity - mlbTrend1)

mlb %>%
  ggplot(aes(x = Date, y = Detrend)) +
  geom_line() +
  geom_smooth() +
  geom_hline(yintercept = 0) +
  theme_minimal()
```

5. Estimate the seasonality of the de-trended series. Plot the average cycle. Comment on the average cycle.


ANSWER: The average cycle shows that from November-March the popularity is below the moving average, but from April-October, the popularity is above the moving average. This is because of the seasonality which makes sense as the MLB season runs from April-October. The data also peaks in July and October, which makes sense because this is when the Allstar game and World Series occur, respectively.

```{r}

lm.season <- lm(Detrend ~ factor(Month), data = mlb)
  
# Add new variable, Season, as the predictions from lm.season to the mlb data set
mlb <- mlb %>%
  mutate(Season = predict(lm.season, newdata = mlb))

# Plot estimated average monthly deviations
mlb %>%
  ggplot(aes(x = Month, y = Detrend, group = Year)) +
  geom_point() +
  geom_line() +
  geom_line(aes(y = Season), color = "purple", size = 2) +
  geom_hline(yintercept = 0) +
  theme_minimal()


```



6. Plot the de-trended series after removing the seasonality (so you are left with the errors). Comment on what you observe.  


ANSWER: The moving average filter does not appear to do a great job at removing the seasonality as there is still a noticeable fluctuation and pattern in the errors. I would assume the moving average would do a better job removing the seasonality, as the goal of the filter is to smooth the data. The model also does a better job at predicting from around 2012 - 2015, but neither 2004-2012 nor 2015-2022. This could be due to the fact that the data points were very similar from 2012-2015, with not too much of a difference between the max and min values among the years.

```{r}
mlb <- mlb %>%
  mutate(Errors = Detrend - Season)

mlb %>%
  ggplot(aes(x = Date, y = Errors)) + 
  geom_point() +
  geom_line() +
  geom_hline(yintercept = 0) + 
  theme_minimal()

```



7. Estimate the autocorrelation of the errors (using `acf()` assuming stationarity) and comment on what you observe about the errors.


ANSWER: The autocorrelation of the errors shows that there is a pattern between the errors, and the seasonality appears, meaning that the model does not do a good job of estimating the trend. I am also assuming stationarity with the data, but the errors do not appear to have a constant variance, meaning that it is not stationary.

```{r}
acf(na.omit(mlb$Errors))
```



8. Predict the relative interest in your keyword based on the trend and seasonality for the next 5 months. We haven't formally learned how to do this but think about how you might do this; be creative. You goal is to see if you can create a plot of the original data and add a red line that shows this prediction. Do your best. 


ANSWER: I used the linear model and applied it to the next 5 months and then added the average seasonality of the given month. I did not use very efficient code to plot it, but I believe it was correct. My original plan was to use the moving average and average seasonality to predict the next months, but I was not sure how to forecast using the moving average. 

```{r}
slope = mlb[2, "mlbTrend2"] - mlb[1, "mlbTrend2"]

avg_season = c(-12.468137, 8.176471, 6.125000, 11.931373, 15.363426)
dates = paste(2022, 3:7, 1 , sep = '-')

for (i in 1:5) {
  n = 218 + i
  mlb[n, "Date"] = dates[i]
  mlb[n, "mlbTrend2"] = slope + mlb[n - 1, "mlbTrend2"]
  mlb[n, "forecast"] = mlb[n, "mlbTrend2"] + avg_season[i]
}

mlb  %>% 
  ggplot(aes(x = Date, y = popularity)) +
  geom_line() + 
  geom_point() +
  geom_line(aes(y = forecast), color = "red") +
  geom_point(aes(y = forecast), color = "red") +
  theme_minimal()
```
